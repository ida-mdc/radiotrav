<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Radiation Event Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; color: #1e293b; }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 24px; margin-bottom: 24px; border: 1px solid #e2e8f0; }

        /* Gallery Styles */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        .gallery-item {
            border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;
            background: #000; transition: transform 0.15s ease;
            position: relative; aspect-ratio: 1;
        }
        .gallery-item:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); border-color: white;}
        .gallery-img {
            width: 100%; height: 100%; object-fit: contain;
            image-rendering: pixelated;
        }
        .gallery-label {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.7); color: white;
            font-size: 10px; padding: 4px; text-align: center;
            backdrop-filter: blur(2px);
        }

        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Class Colors */
        .bg-Alpha { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .bg-Beta { background-color: #e0f2fe; color: #075985; border: 1px solid #7dd3fc; }
        .bg-Gamma { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .bg-Other { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Radiation Event Report</h1>
                <p class="text-slate-500 mt-1">Physics-Based Classification & Morphological Analysis</p>
            </div>
            <div class="flex items-center space-x-3 bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                <span class="text-sm font-semibold text-slate-600">Load CSV:</span>
                <input type="file" id="csv-file-input" accept=".csv" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
            </div>
        </div>

        <div id="loading" class="hidden text-center py-10 text-blue-600 font-semibold animate-pulse">Processing data...</div>

        <div id="dashboard" class="hidden">

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div class="card !mb-0 flex flex-col justify-center items-center bg-slate-800 text-white border-none">
                    <span class="text-slate-400 text-xs uppercase font-bold tracking-wider">Total Events</span>
                    <span class="text-4xl font-bold mt-2" id="stat-total">-</span>
                </div>
                <div class="card !mb-0 flex flex-col justify-center items-center bg-red-50 border-red-200">
                    <span class="text-red-800 text-xs uppercase font-bold tracking-wider">Alphas</span>
                    <span class="text-4xl font-bold mt-2 text-red-600" id="stat-alpha">-</span>
                </div>
                <div class="card !mb-0 flex flex-col justify-center items-center bg-blue-50 border-blue-200">
                    <span class="text-blue-800 text-xs uppercase font-bold tracking-wider">Betas</span>
                    <span class="text-4xl font-bold mt-2 text-blue-600" id="stat-beta">-</span>
                </div>
                <div class="card !mb-0 flex flex-col justify-center items-center bg-green-50 border-green-200">
                    <span class="text-green-800 text-xs uppercase font-bold tracking-wider">Gammas</span>
                    <span class="text-4xl font-bold mt-2 text-green-600" id="stat-gamma">-</span>
                </div>
                <div class="card !mb-0 flex flex-col justify-center items-center bg-gray-50 border-gray-200">
                    <span class="text-gray-600 text-xs uppercase font-bold tracking-wider">Other</span>
                    <span class="text-4xl font-bold mt-2 text-gray-600" id="stat-other">-</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <div class="card col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Particle Morphology Space</h3>
                        <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">Thickness vs. Roundness</span>
                    </div>
                    <div id="scatter-classification" class="h-[400px]"></div>
                </div>

                <div class="card col-span-1">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Group Statistics</h3>
                        <select id="bar-metric" class="text-sm border p-1 rounded bg-slate-50">
                            <option value="total_energy_sum">Total Energy Deposited (Sum)</option>
                            <option value="count">Event Count</option>
                            <option value="mean_energy_avg">Avg Energy Density</option>
                            <option value="mask_roundness_avg">Avg Roundness</option>
                        </select>
                    </div>
                    <div id="bar-chart" class="h-[400px]"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">Event Rate Timeline</h3>
                    <div id="timeline-chart" class="h-[300px]"></div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Property Distributions</h3>
                        <select id="dist-metric" class="text-sm border-slate-300 rounded p-1 bg-slate-50 border">
                            <option value="total_energy">Total Energy</option>
                            <option value="mask_roundness">Roundness</option>
                            <option value="max_radius">Thickness (Radius)</option>
                            <option value="mask_area">Area (px)</option>
                        </select>
                    </div>
                    <div id="violin-chart" class="h-[300px]"></div>
                </div>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-700">Sensor Hitmap</h3>
                    <span class="text-xs text-slate-500">Spatial Distribution (X,Y)</span>
                </div>
                <div id="scatter-sensor" class="h-[400px]"></div>
            </div>

            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-700">Event Gallery (Top 200)</h3>
                    <div class="flex gap-2 mt-2 md:mt-0">
                        <select id="gallery-filter" class="text-sm border p-2 rounded bg-slate-50">
                            <option value="all">All Classes</option>
                            <option value="Alpha">Alpha Only</option>
                            <option value="Beta">Beta Only</option>
                            <option value="Gamma">Gamma Only</option>
                            <option value="Other">Other</option>
                        </select>
                        <select id="gallery-sort" class="text-sm border p-2 rounded bg-slate-50">
                            <option value="energy_desc">Highest Energy</option>
                            <option value="roundness_desc">Roundest</option>
                            <option value="size_desc">Largest</option>
                        </select>
                    </div>
                </div>
                <div id="gallery-container" class="gallery-grid custom-scroll max-h-[600px] overflow-y-auto p-1"></div>
            </div>

            <div class="card">
                <h3 class="text-lg font-bold text-slate-700 mb-4">Raw Data Explorer</h3>
                <div id="grid-table"></div>
            </div>

        </div>
    </div>

    <script>
        let globalData = [];

        const colors = {
            'Alpha': '#dc2626', // Red
            'Beta': '#2563eb',  // Blue
            'Gamma': '#16a34a', // Green
            'Other': '#9ca3af'  // Gray
        };

        // --- 1. LOAD DATA ---
        document.getElementById('csv-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        processData(results.data);
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                    } catch (err) {
                        console.error(err);
                        alert("Processing Error: " + err.message);
                        document.getElementById('loading').classList.add('hidden');
                    }
                },
                error: function(err) {
                    alert("Error parsing CSV: " + err.message);
                    document.getElementById('loading').classList.add('hidden');
                }
            });
        });

        // --- 2. PROCESS DATA ---
        function processData(data) {
            // 1. Filter valid rows
            globalData = data.filter(r => r.Cluster_ID !== undefined && r.mean_t !== null);

            console.log(`Loaded ${globalData.length} rows.`);

            // 2. Normalize Time (Loop to avoid stack overflow)
            if (globalData.length > 0) {
                let t0 = globalData[0].mean_t;
                for (let i = 1; i < globalData.length; i++) {
                    if (globalData[i].mean_t < t0) t0 = globalData[i].mean_t;
                }
                for (let i = 0; i < globalData.length; i++) {
                    globalData[i].rel_time_sec = (globalData[i].mean_t - t0) / 1e9;
                    // Ensure class exists
                    if (!globalData[i].class) globalData[i].class = 'Other';
                }
            }

            // 3. Downsample for Scatter Plots
            const SAMPLE_LIMIT = 15000;
            const step = Math.ceil(globalData.length / SAMPLE_LIMIT);
            const sampledData = (step > 1)
                ? globalData.filter((_, i) => i % step === 0)
                : globalData;

            renderStats();
            renderClassificationPlot(sampledData);
            renderSensorMap(sampledData);
            renderTimeline();
            renderDistributions();
            renderBarChart();
            renderGallery();
            renderTable();
        }

        // --- 3. RENDER STATS ---
        function renderStats() {
            const counts = { Total: 0, Alpha: 0, Beta: 0, Gamma: 0, Other: 0 };
            globalData.forEach(d => {
                counts.Total++;
                if (counts[d.class] !== undefined) counts[d.class]++;
                else counts.Other++;
            });

            document.getElementById('stat-total').textContent = counts.Total.toLocaleString();
            document.getElementById('stat-alpha').textContent = counts.Alpha.toLocaleString();
            document.getElementById('stat-beta').textContent = counts.Beta.toLocaleString();
            document.getElementById('stat-gamma').textContent = counts.Gamma.toLocaleString();
            document.getElementById('stat-other').textContent = counts.Other.toLocaleString();
        }

        // --- 4. CHARTS ---

        function renderClassificationPlot(plotData) {
            // Prefer new metrics if available, fallback to old
            const hasNewMetrics = plotData.length > 0 && plotData[0].max_radius !== undefined;
            const xField = hasNewMetrics ? 'mask_roundness' : 'aspect_ratio';
            const yField = hasNewMetrics ? 'max_radius' : 'mean_energy';
            const xLabel = hasNewMetrics ? 'Geometric Roundness' : 'Aspect Ratio';
            const yLabel = hasNewMetrics ? 'Thickness (Max Radius)' : 'Mean Energy';

            const traces = [];
            ['Alpha', 'Beta', 'Gamma', 'Other'].forEach(cls => {
                const subset = plotData.filter(d => d.class === cls);
                if (subset.length === 0) return;

                traces.push({
                    x: subset.map(d => d[xField]),
                    y: subset.map(d => d[yField]),
                    mode: 'markers',
                    type: 'scattergl',
                    name: cls,
                    marker: { color: colors[cls], size: 4, opacity: 0.6 }
                });
            });

            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 50 },
                xaxis: { title: xLabel, range: [0, 1.1] },
                yaxis: { title: yLabel }, // thickness usually linear is fine
                hovermode: 'closest', paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
            };
            Plotly.newPlot('scatter-classification', traces, layout);
        }

        function renderBarChart() {
            const metricKey = document.getElementById('bar-metric').value; // e.g. "total_energy_sum"
            const [field, op] = metricKey.split('_').slice(0, -1).join('_') ? [metricKey.split('_').slice(0, -1).join('_'), metricKey.split('_').pop()] : [metricKey, 'count'];

            // Calculate Aggregates
            const classes = ['Alpha', 'Beta', 'Gamma', 'Other'];
            const values = classes.map(cls => {
                const subset = globalData.filter(d => d.class === cls);
                if (subset.length === 0) return 0;

                if (metricKey === 'count') return subset.length;

                const sum = subset.reduce((acc, curr) => acc + (curr[field] || 0), 0);
                if (op === 'sum') return sum;
                if (op === 'avg') return sum / subset.length;
                return 0;
            });

            const trace = {
                x: classes,
                y: values,
                type: 'bar',
                marker: { color: classes.map(c => colors[c]) }
            };

            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 50 },
                yaxis: { title: document.getElementById('bar-metric').selectedOptions[0].text },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
            };
            Plotly.newPlot('bar-chart', [trace], layout);
        }
        document.getElementById('bar-metric').addEventListener('change', renderBarChart);

        function renderSensorMap(plotData) {
            const trace = {
                x: plotData.map(d => d.mean_x),
                y: plotData.map(d => d.mean_y),
                mode: 'markers',
                type: 'scattergl',
                marker: {
                    size: 3,
                    color: plotData.map(d => colors[d.class] || colors.Other),
                    opacity: 0.6
                },
                text: plotData.map(d => `ID: ${d.Cluster_ID}`),
                hoverinfo: 'text'
            };

            const layout = {
                margin: { t: 10, r: 10, b: 30, l: 30 },
                xaxis: { range: [0, 256], title: 'X', showgrid: false },
                yaxis: { range: [0, 256], title: 'Y', scaleanchor: "x", scaleratio: 1, showgrid: false },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: '#f8fafc',
                shapes: [{ type: 'rect', x0: 0, y0: 0, x1: 256, y1: 256, line: { color: '#ccc' } }]
            };
            Plotly.newPlot('scatter-sensor', [trace], layout);
        }

        function renderTimeline() {
            const traces = [];
            ['Alpha', 'Beta', 'Gamma', 'Other'].forEach(cls => {
                const subset = globalData.filter(d => d.class === cls);
                traces.push({
                    x: subset.map(d => d.rel_time_sec),
                    type: 'histogram',
                    name: cls,
                    marker: { color: colors[cls] },
                    opacity: 0.75
                });
            });
            const layout = {
                barmode: 'stack', margin: { t: 20, r: 20, b: 40, l: 50 },
                xaxis: { title: 'Time (seconds)' }, yaxis: { title: 'Events per Bin' },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
            };
            Plotly.newPlot('timeline-chart', traces, layout);
        }

        function renderDistributions() {
            const metric = document.getElementById('dist-metric').value;
            const traces = [];
            ['Alpha', 'Beta', 'Gamma', 'Other'].forEach(cls => {
                const subset = globalData.filter(d => d.class === cls);
                if (subset.length === 0) return;

                // Fallback if metric missing in CSV (e.g. using old CSV with new logic)
                const dataPoints = subset.map(d => d[metric] !== undefined ? d[metric] : 0);

                traces.push({
                    y: dataPoints,
                    type: 'violin', name: cls, box: { visible: true },
                    line: { color: colors[cls] }, meanline: { visible: true }
                });
            });
            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 50 },
                yaxis: { title: metric.replace(/_/g, ' ') },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
            };
            Plotly.newPlot('violin-chart', traces, layout);
        }
        document.getElementById('dist-metric').addEventListener('change', renderDistributions);

        // --- 5. GALLERY ---
        function renderGallery() {
            const container = document.getElementById('gallery-container');
            const filterClass = document.getElementById('gallery-filter').value;
            const sortMode = document.getElementById('gallery-sort').value;

            let subset = globalData;
            if (filterClass !== 'all') {
                subset = globalData.filter(d => d.class === filterClass);
            }

            // Robust Sort
            subset.sort((a, b) => {
                const valA = sortMode.includes('energy') ? a.total_energy : (sortMode.includes('size') ? a.mask_area || a.area : a.mask_roundness || a.aspect_ratio);
                const valB = sortMode.includes('energy') ? b.total_energy : (sortMode.includes('size') ? b.mask_area || b.area : b.mask_roundness || b.aspect_ratio);
                return valB - valA; // Descending
            });

            const displaySet = subset.slice(0, 200);

            container.innerHTML = displaySet.map(d => {
                const bgClass = `bg-${d.class}`;
                let rawSrc = d.thumbnail_png || d.thumbnail || '';
                let imgSrc = rawSrc.startsWith('data:image') ? rawSrc : 'data:image/png;base64,' + rawSrc;
                if (!rawSrc) imgSrc = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PC9zdmc+';

                return `
                    <div class="gallery-item cursor-pointer" onclick="alert('ID: ${d.Cluster_ID}\\nE: ${d.total_energy}\\nR: ${d.mask_roundness?.toFixed(2)}')">
                        <img src="${imgSrc}" class="gallery-img" loading="lazy">
                        <div class="gallery-label">
                            <span class="text-[9px] uppercase font-bold px-1 rounded ${bgClass}">${d.class}</span>
                            <div class="mt-1">${Math.round(d.total_energy)} keV</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        document.getElementById('gallery-filter').addEventListener('change', renderGallery);
        document.getElementById('gallery-sort').addEventListener('change', renderGallery);

        // --- 6. DATA TABLE ---
        let gridInstance = null;
        function safeFixed(val, digits) {
            return (val !== null && val !== undefined && typeof val === 'number') ? val.toFixed(digits) : '0.00';
        }

        function renderTable() {
            const displayData = globalData.map(d => [
                d.Cluster_ID,
                d.class,
                safeFixed(d.rel_time_sec, 3),
                safeFixed(d.total_energy, 1),
                d.mask_area || d.area, // Prefer mask_area
                safeFixed(d.mask_roundness || d.aspect_ratio, 2),
                safeFixed(d.max_radius, 1) // Thickness
            ]);

            if (gridInstance) {
                gridInstance.updateConfig({ data: displayData }).forceRender();
            } else {
                gridInstance = new gridjs.Grid({
                    columns: [
                        'ID',
                        { name: 'Class', formatter: (cell) => gridjs.html(`<span class="font-bold ${cell=='Alpha'?'text-red-600':cell=='Beta'?'text-blue-600':cell=='Gamma'?'text-green-600':'text-gray-500'}">${cell}</span>`) },
                        'Time (s)', 'Energy', 'Area', 'Roundness', 'Thick.'
                    ],
                    data: displayData,
                    pagination: { limit: 10 },
                    search: true, sort: true, resizable: true,
                    style: { table: { 'font-size': '13px' }, th: { 'background-color': '#f8fafc' } }
                }).render(document.getElementById("grid-table"));
            }
        }
    </script>
</body>
</html>